<!doctype html>
<html lang="en">
  <!--begin::Head-->
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Apartemen Kepiting</title>
    <!--begin::Primary Meta Tags-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="title" content="Apartemen Kepiting" />
    <!--end::Primary Meta Tags-->
    <!--begin::Fonts-->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
      integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q="
      crossorigin="anonymous"
    />
    <!--end::Fonts-->
    <!--begin::Third Party Plugin(Bootstrap Icons)-->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI="
      crossorigin="anonymous"
    />
    <!--end::Third Party Plugin(Bootstrap Icons)-->
    <!--begin::Required Plugin(AdminLTE)-->
    <link rel="stylesheet" href="../static/adminlte.css" />
    <!--end::Required Plugin(AdminLTE)-->
    <!-- Bootstrap Switch CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-switch@3.4.0/dist/css/bootstrap3/bootstrap-switch.min.css">
  </head>
  <!--end::Head-->
  <!--begin::Body-->
  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <!--begin::App Wrapper-->
    <div class="app-wrapper">
      <!--begin::Header-->
      <nav class="app-header navbar navbar-expand bg-body">
        <!--begin::Container-->
        <div class="container-fluid">
          <!--begin::Start Navbar Links-->
          <ul class="navbar-nav">
            <li class="nav-item">
              <h3 class="mb-0">Dashboard Apartemen Kepiting</h3>
            </li>
          </ul>
          <!--end::Start Navbar Links-->
          <!--begin::End Navbar Links-->
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <p class="nav-link mb-0"><span style="font-weight:bold;" id="hari"></span>, <span style="font-weight:bold;color:darkblue;" id="tanggal"></span> <span style="font-weight:bold; color:red;" id="jam"></span></p>
            </li>
            <!--begin::Fullscreen Toggle-->
            <li class="nav-item">
              <a class="nav-link" href="#" data-lte-toggle="fullscreen">
                <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none"></i>
              </a>
            </li>
            <!--end::Fullscreen Toggle-->
          </ul>
          <!--end::End Navbar Links-->
        </div>
        <!--end::Container-->
      </nav>
      <!--end::Header-->
      <!--begin::App Main-->
      <main class="app-main">
        <!--begin::App Content-->
        <div class="app-content pt-3">
          <!--begin::Container-->
          <div class="container-fluid">
            <!--begin::Row-->
            <div class="row" id="kamar-container"></div> <!-- Tempat untuk menampilkan kartu kamar -->
            <!-- /.row (main row) -->
          </div>
          <!--end::Container-->
        </div>
        <!--end::App Content-->
      </main>
      <!--end::App Main-->
      <!--begin::Footer-->
      <footer class="app-footer">
        <!--begin::Copyright-->
        <strong>
          Copyright &copy; 2025&nbsp;
          <a href="#" class="text-decoration-none">Kelompok 1</a>.
        </strong>
        All rights reserved.
        <!--end::Copyright-->
      </footer>
      <!--end::Footer-->
    </div>
    <!--end::App Wrapper-->
    <!--begin::Script--><!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!--begin::Required Plugin(popperjs for Bootstrap 5)-->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <!--end::Required Plugin(popperjs for Bootstrap 5)--><!--begin::Required Plugin(Bootstrap 5)-->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>
    <!--end::Required Plugin(Bootstrap 5)--><!--begin::Required Plugin(AdminLTE)-->
    <script src="../static/adminlte.js"></script>
    <!--end::Required Plugin(AdminLTE)-->
    <!-- Bootstrap Switch JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-switch@3.4.0/dist/js/bootstrap-switch.min.js"></script>
    <!-- OPTIONAL SCRIPTS -->
    <script>
      $(document).ready(function () {
        // Simulasi Data JSON Dummy (Jika API tidak tersedia)
        const dummyData = [
          {
              "kamar": "Kamar 1",
              "tanggal_masuk": "12-02-2025",
              "temperatur": { "value": 25.15, "status": "success" },
              "ph": { "value": 7.4, "status": "success" },
              "garam": { "value": 14, "status": "success" },
              "oksigen": { "value": 7.4, "status": "success" },
              "debit": { "value": 9, "status": "success" },
              "life": { "value": "ada", "status": "success" },
              "pompa": "on",
              "aerator": "on"
          },
          {
              "kamar": "Kamar 2",
              "tanggal_masuk": "10-03-2025",
              "temperatur": { "value": 26.5, "status": "warning" },
              "ph": { "value": 7.2, "status": "success" },
              "garam": { "value": 12, "status": "warning" },
              "oksigen": { "value": 8.0, "status": "success" },
              "debit": { "value": 8, "status": "warning" },
              "life": { "value": "ada", "status": "success" },
              "pompa": "off",
              "aerator": "on"
          }
      ];

    
        // Fungsi untuk menghitung jumlah hari sejak tanggal masuk
        function hitungHari(tanggalMasuk) {
          const tglMasuk = new Date(tanggalMasuk.split('-').reverse().join('-'));
          const tglSekarang = new Date();
          const selisihHari = Math.floor((tglSekarang - tglMasuk) / (1000 * 60 * 60 * 24));
          return selisihHari > 0 ? selisihHari : 0;
        }
    
        // Fungsi untuk membuat elemen kartu kamar
        function buatKamar(data) {
          // Periksa apakah semua info-box memiliki status success
          const semuaSuccess = [data.temperatur, data.ph, data.garam, data.oksigen, data.debit, data.life]
              .every(item => item.status === "success");

          // Tentukan kelas kartu berdasarkan status info-box
          const cardClass = semuaSuccess ? "card-success" : "card-warning";

          return `
              <div class="col-md-6 pb-3">
                  <div class="card ${cardClass}" id="card-${data.kamar.replace(/\s/g, '')}">
                      <div class="card-header">
                          <div class="btn-group mb-2" role="group">
                              <button type="button" class="btn btn-primary"><i class="bi bi-box2-fill"></i> ${data.kamar}</button>
                              <button type="button" class="btn btn-info"><i class="bi bi-box-arrow-in-down"></i> ${data.tanggal_masuk}</button>
                              <button type="button" class="btn btn-secondary"><i class="bi bi-calendar-date"></i> ${hitungHari(data.tanggal_masuk)} Hari</button>
                          </div>
                      </div>
                      <div class="card-body">
                          <div class="row">
                              ${buatInfoBox("bi-thermometer-half", "Temperatur Air", data.temperatur, "Tidak Napsu Makan", "Â°C")}
                              ${buatInfoBox("bi-droplet-half", "PH Air", data.ph, "Stres", "")}
                              ${buatInfoBox("bi-umbrella", "Kadar Garam", data.garam, "Resiko Infeksi Bakteri", "ppt")}
                              ${buatInfoBox("bi-lungs-fill", "Kadar Oksigen", data.oksigen, "Stres", "mg/L")}
                              ${buatInfoBox("bi-tropical-storm", "Debit Air", data.debit, "Kadar Oksigen Rendah", "L/s")}
                              ${buatInfoBox("bi-activity", "Kehidupan", data.life, "12-02-2025 09.20", "")}
                              ${buatSwitch("bi-fan", "Pompa Air", `pompa-${data.kamar.replace(/\s/g, '')}`, data.pompa)}
                              ${buatSwitch("bi-wind", "Aerator Oksigen", `aerator-${data.kamar.replace(/\s/g, '')}`, data.aerator)}
                          </div>
                      </div>
                  </div>
              </div>`;
        }

      
        // Fungsi untuk membuat info-box
        function buatInfoBox(icon, title, data, description, unit) {
          const statusClass = data.status === "success" ? "text-bg-success" : "text-bg-warning";
          const valueDisplay = (typeof data.value === "string") ? data.value.toUpperCase() : data.value; // Ubah ke uppercase jika string
      
          return `
            <div class="col-md-6 col-sm-6 col-12">
                <div class="info-box ${statusClass}">
                    <span class="info-box-icon"> <i class="bi ${icon}"></i> </span>
                    <div class="info-box-content">
                        <span class="info-box-text">${title}</span>
                        <span class="info-box-number">${valueDisplay} ${unit}</span> 
                        <div class="progress"><div class="progress-bar" style="width: 70%"></div></div>
                        <span class="progress-description"> ${description} </span>
                    </div>
                </div>
            </div>`;
        }
      
        // Fungsi untuk membuat switch kontrol
        function buatSwitch(icon, title, id, state) {
          const isChecked = state === "on" ? "checked" : "";
          return `
          <div class="col-md-6 col-sm-6 col-12">
            <div class="info-box text-bg-${state === "on" ? "success" : "warning"}" id="${id}-info-box">
              <span class="info-box-icon"> <i class="bi ${icon}"></i> </span>
              <div class="info-box-content">
                <span class="info-box-text">${title}</span>
                <input type="checkbox" id="${id}-switch" ${isChecked} data-bootstrap-switch data-state="${state}">
                <div class="progress"><div class="progress-bar" style="width: 70%"></div></div>
              </div>
            </div>
          </div>`;
        }
    
        // Fungsi untuk inisialisasi toggle switch
        function inisialisasiToggleSwitch() {
          $('[data-bootstrap-switch]').each(function () {
            const $this = $(this);
            const defaultState = ($this.attr('data-state') || '').toLowerCase().trim() === 'on';
            $this.prop('checked', defaultState);
            $this.bootstrapSwitch({
              onText: 'ON',
              offText: 'OFF',
              onColor: 'success',
              offColor: 'danger',
              size: 'small'
            });
    
            // Event listener untuk toggle switch
            $this.on('switchChange.bootstrapSwitch', function (event, state) {
              const infoBox = $(`#${$this.attr('id').replace('-switch', '-info-box')}`);
              if (state) {
                infoBox.removeClass('text-bg-warning').addClass('text-bg-success');
              } else {
                infoBox.removeClass('text-bg-success').addClass('text-bg-warning');
              }
    
              // Periksa status semua info-box di dalam card
              const card = infoBox.closest('.card');
              const semuaSuccess = card.find('.info-box').toArray().every(box => $(box).hasClass('text-bg-success'));
    
              // Ubah kelas card berdasarkan status info-box
              if (semuaSuccess) {
                card.removeClass('card-warning').addClass('card-success');
              } else {
                card.removeClass('card-success').addClass('card-warning');
              }
            });
          });
        }
    
        // Ambil data dari API atau gunakan data dummy jika API gagal
        const apiUrl = "http://192.168.57.58:5000/data";
    
        // Fungsi untuk mengambil data
        function ambilData() {
          console.log("Mengambil data dari API..."); // Log sebelum request

          $.getJSON(apiUrl, function (data) {
              console.log("Data berhasil diambil dari API:", data); // Log jika sukses
              tampilkanKamar(data);
          }).fail(function (jqXHR, textStatus, errorThrown) {
              console.warn("Gagal mengambil data dari API. Menggunakan data dummy."); // Log jika gagal
              console.warn("Error:", textStatus, errorThrown); // Menampilkan pesan error
              tampilkanKamar(dummyData);
          });
        }
    
        // Fungsi untuk menampilkan kamar ke dalam container
        function tampilkanKamar(data) {
          const container = $("#kamar-container");
          container.empty(); // Kosongkan container
          data.slice(0, 10).forEach(item => container.append(buatKamar(item)));
    
          // Inisialisasi Bootstrap Switch setelah elemen dimasukkan ke DOM
          inisialisasiToggleSwitch();
        }
    
        // Fungsi untuk memperbarui tanggal dan waktu
        function updateWaktu() {
          const date = new Date();
    
          // Format nama hari dan tanggal dalam bahasa Indonesia
          const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
          const formattedDate = date.toLocaleDateString('id-ID', options);
    
          // Format jam dengan angka dua digit (24 jam format)
          const formattedTime = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    
          // Memisahkan nama hari dari tanggal lengkap
          const [hari, tanggal] = formattedDate.split(', ');
    
          // Perbarui elemen DOM
          $('#hari').text(hari); // Nama hari
          $('#tanggal').text(tanggal); // Tanggal lengkap
          $('#jam').text(formattedTime); // Jam dalam format 24 jam
        }

        function showPinPrompt(callback) {
          const modal = $(`
              <div class="modal" tabindex="-1" role="dialog">
                  <div class="modal-dialog" role="document">
                      <div class="modal-content">
                          <div class="modal-header">
                              <h5 class="modal-title">Masukkan PIN</h5>
                              <button type="button" class="close ml-auto position-absolute" style="right: 10px; top: 10px;" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                              </button>

                          </div>
                          <div class="modal-body">
                              <input type="password" id="pin-input" class="form-control" placeholder="Masukkan PIN">
                          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-primary" id="confirm-pin">OK</button>
                              <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                          </div>
                      </div>
                  </div>
              </div>
          `);
          
          $('body').append(modal);
          modal.modal('show');
          
          modal.find('#confirm-pin').click(function () {
              const pin = modal.find('#pin-input').val();
              modal.modal('hide');
              modal.remove();
              
              if (pin === "1234") {
                  callback(true);
              } else {
                  alert("PIN salah!");
                  callback(false);
              }
          });
        }
    
        function inisialisasiToggleSwitch() {
            $('[data-bootstrap-switch]').each(function () {
                const $this = $(this);
                const defaultState = ($this.attr('data-state') || '').toLowerCase().trim() === 'on';
                $this.prop('checked', defaultState);
                $this.bootstrapSwitch({
                    onText: 'ON',
                    offText: 'OFF',
                    onColor: 'success',
                    offColor: 'danger',
                    size: 'small'
                });
    
                $this.on('switchChange.bootstrapSwitch', function (event, state) {
                  showPinPrompt(function (isAuthenticated) {
                    if (!isAuthenticated) {
                      $this.bootstrapSwitch('state', !state, true);
                      return;
                    }
                
                    const infoBox = $(`#${$this.attr('id').replace('-switch', '-info-box')}`);
                    if (state) {
                      infoBox.removeClass('text-bg-warning').addClass('text-bg-success');
                    } else {
                      infoBox.removeClass('text-bg-success').addClass('text-bg-warning');
                    }
                
                    const card = infoBox.closest('.card');
                    const semuaSuccess = card.find('.info-box').toArray().every(box => $(box).hasClass('text-bg-success'));
                    if (semuaSuccess) {
                      card.removeClass('card-warning').addClass('card-success');
                    } else {
                      card.removeClass('card-success').addClass('card-warning');
                    }
                
                    // Ambil nama kamar dan jenis switch dari ID
                    const id = $this.attr('id');
                    const kamar = id.split('-')[1];
                    const jenis = id.split('-')[0];
                
                    // Kirim status switch ke server
                    kirimStatusSwitch(kamar, jenis, state ? 'on' : 'off');
                  });
                });

            });
        }
    
        inisialisasiToggleSwitch();

        function kirimStatusSwitch(kamar, jenis, status) {
          const data = {
            kamar: kamar,
            jenis: jenis,
            status: status
          };
        
          fetch('http://192.168.57.58:5000/submit', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          })
          .then(response => response.json())
          .then(result => {
            console.log('Status switch berhasil dikirim:', result);
          })
          .catch(error => {
            console.error('Gagal mengirim status switch:', error);
          });
        }
    
        // Panggil fungsi pertama kali agar tampilan langsung muncul
        updateWaktu();
        // Panggil fungsi ambilData pertama kali
        ambilData();
        // Memperbarui waktu setiap 1 detik (1000 milidetik)
        setInterval(updateWaktu, 1000);
        // Jalankan ambilData setiap 2 detik
        setInterval(ambilData, 1000*60*10); // Ambil data setiap 10 menit
      });
    </script>
  </body>
  <!--end::Body-->
</html>
